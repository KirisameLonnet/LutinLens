# 内嵌AI服务器使用说明

## 概述

LutinLens现在支持内嵌HTTP服务器功能，允许应用在测试模式下自己启动一个本地服务器。**这是一个纯测试功能，不处理任何实际图像或进行真实的AI分析**。服务器仅返回预设的测试响应序列。

## 功能特点

- 🚀 **应用内启动**: 直接在Android应用内启动HTTP服务器
- 🔄 **固定序列测试**: 循环返回"向左移动 → 绿色对勾 → 向右移动"
- 📡 **标准API**: 完全兼容正常的AI建议API格式
- 🎯 **无AI处理**: 仅用于测试，不分析图像内容
- 📊 **详细日志**: 显示服务器启动状态和请求处理日志
- 🖼️ **图片检测**: 检查请求是否包含图片数据，无图片时返回错误提示
- 🧪 **故障模拟**: 测试模式下偶尔不发送图片以测试错误处理

## 测试序列

⚠️ **重要**: 这是固定的测试序列，与发送的图像内容无关：

1. **向左移动建议** (ready_to_shoot: 0) - 显示1.5秒后隐藏
2. **绿色对勾状态** (ready_to_shoot: 1) - 持续显示绿色对勾图标
3. **向右移动建议** (ready_to_shoot: 0) - 显示1.5秒后隐藏

序列每3秒切换一次，无限循环。

## 工作原理

1. **启动测试模式**: 在设置中开启"AI测试模式"
2. **内嵌服务器启动**: 应用在127.0.0.1:1234启动HTTP服务器
3. **自动配置**: 自动将AI服务器地址设置为127.0.0.1:1234
4. **真实请求**: 应用每3秒向自己的服务器发送POST请求
5. **模拟响应**: 内嵌服务器返回预设的AI建议响应

## 使用步骤

### 1. 启用测试模式
1. 打开应用设置
2. 找到"AI设置"部分
3. 开启"AI智能建议"
4. 开启"AI测试模式"

### 2. 观察效果
返回相机页面，右下角的AI建议窗口将显示：
- 真实的HTTP请求响应
- 循环的建议序列
- 1.5秒自动隐藏（非ready_to_shoot状态）
- 绿色对勾状态显示

### 3. 检查日志
在Flutter控制台可以看到：
```
[AI] 启动测试模式
[内嵌服务器] ✅ 启动成功
[内嵌服务器] 📍 地址: http://127.0.0.1:1234
[内嵌服务器] 📡 API端点: POST /ai/suggestion
[内嵌服务器] 📨 POST /ai/suggestion (请求 #1)
[内嵌服务器] 📷 图片数据: 已接收 (1234字符)
[内嵌服务器] ✅ 响应: 向左移动相机以获得更好的构图
```

### 4. 无图片测试
系统会偶尔故意不发送图片数据来测试错误处理：
```
[AI] 🧪 测试：故意不发送图片数据
[内嵌服务器] 📨 POST /ai/suggestion (请求 #3)
[内嵌服务器] 📷 图片数据: 未收到图片
[内嵌服务器] ❌ 错误：未收到图片数据
[内嵌服务器] 📤 已发送无图片响应
```

## API格式

### 请求格式
```json
{
  "session_id": "uuid-string",
  "img": "data:image/jpeg;base64,/9j/...",
  "timestamp": "2023-09-06T10:30:00.000Z"
}
```

### 正常响应格式
```json
{
  "suggestion": "向左移动相机以获得更好的构图",
  "ready_to_shoot": 0,
  "server_time": "2023-09-06T10:30:00.000Z",
  "request_id": 1,
  "session_id": "uuid-string",
  "server_type": "embedded"
}
```

### 无图片错误响应格式
```json
{
  "error": "No Image Data",
  "message": "未收到图片数据",
  "suggestion": "请确保正确发送图片数据到服务器",
  "ready_to_shoot": 0,
  "server_type": "embedded",
  "session_id": "uuid-string",
  "timestamp": "2023-09-06T10:30:00.000Z",
  "request_id": 3
}
```

## 预设响应序列

⚠️ **这是纯测试功能**: 内嵌服务器不分析图像，只返回固定的测试序列：

1. **步骤1: 向左移动建议** 
   - 消息: "向左移动相机以获得更好的构图"
   - ready_to_shoot: 0
   - 效果: 显示建议1.5秒后自动隐藏

2. **步骤2: 准备拍摄状态**
   - 消息: "完美！现在可以拍摄了"  
   - ready_to_shoot: 1
   - 效果: 显示绿色对勾图标，持续显示

3. **步骤3: 向右移动建议**
   - 消息: "向右移动相机调整拍摄角度"
   - ready_to_shoot: 0  
   - 效果: 显示建议1.5秒后自动隐藏

**循环**: 每3秒自动切换到下一步，无限重复 1→2→3→1→2→3...

## 技术实现

### 核心文件
- `lib/src/services/embedded_ai_server.dart` - 内嵌HTTP服务器
- `lib/src/services/ai_suggestion_service.dart` - AI建议服务（已更新）
- `lib/src/pages/settings_page.dart` - 设置页面（已更新）

### 关键类
- `EmbeddedAiServer` - 管理内嵌HTTP服务器
- `AiSuggestionService` - 集成内嵌服务器支持

## 优势

### 相比纯本地模拟
- ✅ 测试真实的HTTP请求/响应流程
- ✅ 验证JSON序列化/反序列化
- ✅ 检测网络相关的潜在问题
- ✅ 完全兼容生产环境的代码路径

### 相比外部服务器
- ✅ 无需额外服务器设置
- ✅ 完全离线工作
- ✅ 不依赖网络连接
- ✅ 集成到应用中，易于部署

## 故障排除

### 端口占用问题
如果看到"Address already in use"错误：
1. 重启应用
2. 检查是否有其他应用使用1234端口
3. 关闭测试模式再重新开启

### 服务器启动失败
如果内嵌服务器无法启动，系统会自动回退到纯本地模拟模式。

### 请求失败
检查Flutter控制台日志，查看具体的错误信息。

## 注意事项

1. **仅限测试**: 此功能仅用于开发和测试
2. **性能影响**: 内嵌服务器会消耗少量额外资源
3. **端口固定**: 目前固定使用1234端口
4. **自动配置**: 测试模式会自动覆盖AI服务器地址设置
